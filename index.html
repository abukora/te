<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>لوحة التحكم - نظام التعديات</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <?!= HtmlService.createHtmlOutputFromFile('CSS').getContent(); ?>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-success shadow">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold fs-4" href="/">نظام إدارة التعديات</a>
      <a href="?page=form" class="btn btn-warning fw-bold">إضافة تعدي جديد</a>
    </div>
  </nav>

  <div class="container-fluid py-4">
    <div class="row g-4" id="stats">
      <div class="col-md-4">
        <div class="card text-white bg-danger shadow">
          <div class="card-body">
            <h5>إجمالي التعديات</h5>
            <h2 id="totalCount">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-white bg-primary shadow">
          <div class="card-body">
            <h5>إجمالي المساحة</h5>
            <h2 id="totalArea">0 م²</h2>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-lg-6">
        <div class="card shadow">
          <div class="card-header bg-dark text-white">خريطة التعديات</div>
          <div id="map" style="height:380px;"></div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card shadow">
          <div class="card-header bg-dark text-white">أحدث التعديات</div>
          <div class="card-body">
            <table id="dataTable" class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>التاريخ</th>
                  <th>المتعدي</th>
                  <th>الحوض</th>
                  <th>المساحة</th>
                  <th>الحالة</th>
                  <th>عرض</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <script>
    let map = L.map('map').setView([26.8206, 30.8025], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    google.script.run.withSuccessHandler(data => {
      $('#totalCount').text(data.length);
      const areaSum = data.reduce((a,b) => a + (Number(b['المساحة الكلية م² (أتوماتيك)'])||0), 0);
      $('#totalArea').text(areaSum.toLocaleString() + ' م²');

      data.forEach(r => {
        if (r['موقع على الخريطة (Lat,Lng)']) {
          const [lat,lng] = r['موقع على الخريطة (Lat,Lng)'].split(',');
          L.marker([lat,lng]).addTo(map)
            .bindPopup(`<b>${r['اسم المتعدي']}</b><br>${r['المساحة الكلية م² (أتوماتيك)']} م²`);
        }
      });

      $('#dataTable').DataTable({
        data: data,
        order: [[0, 'desc']],
        columns: [
          { data: 'تاريخ التسجيل', render: d => new Date(d).toLocaleDateString('ar-EG') },
          { data: 'اسم المتعدي' },
          { data: 'الحوض' },
          { data: 'المساحة الكلية م² (أتوماتيك)' },
          { data: 'حالة الإزالة', render: s => `<span class="badge bg-warning">${s}</span>` },
          { data: 'رابط الخريطة', render: l => l ? `<a href="${l}" target="_blank" class="btn btn-sm btn-info">عرض</a>` : '' }
        ],
        language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json' }
      });
    }).getAllEncroachments();
  </script>
</body>
</html>
